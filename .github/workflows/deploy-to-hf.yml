name: CI/CD - Test & Deploy to Hugging Face Space

permissions:
  contents: write

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:      

permissions:
  contents: read          
  id-token: write         

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"
  HF_SPACE: "alrazumov/vibration-predictor"

jobs:
  test-and-lint:
    name: Test and Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
            fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Run unit tests
        run: |
          pytest -q --maxfail=1 tests/
          
  deploy:
      name: Deploy to Hugging Face Space
      needs: test-and-lint
      runs-on: ubuntu-latest
      if: ${{ github.ref == 'refs/heads/main' }}

      steps:
        - name: Checkout code
          uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Install dependencies for deployment
          run: |
            python -m pip install --upgrade pip
            pip install git-lfs huggingface_hub

        - name: Configure HF token
          env:
            HF_TOKEN: ${{ secrets.HF_TOKEN }}
          run: |
            mkdir -p ~/.huggingface
            echo $HF_TOKEN > ~/.huggingface/token

        - name: Set Git identity
          run: |
            git config user.email "actions@github.com"
            git config user.name "github-actions[bot]"

        - name: Clone HF Space repo
          env:
            HF_SPACE: ${{ env.HF_SPACE }}
            HF_TOKEN: ${{ secrets.HF_TOKEN }}
          run: |
            set -e
            TMPDIR=$(mktemp -d)
            git clone https://$HF_TOKEN@huggingface.co/spaces/${HF_SPACE} ${TMPDIR}/space

        - name: Sync contents to Space
          env:
            HF_SPACE: ${{ env.HF_SPACE }}
            HF_TOKEN: ${{ secrets.HF_TOKEN }}
          run: |
            TMPDIR=$(mktemp -d)
            git clone https://$HF_TOKEN@huggingface.co/spaces/${HF_SPACE} ${TMPDIR}/space

            rsync -av --delete \
              --exclude '.git/' \
              --exclude '.github/' \
              $GITHUB_WORKSPACE/ ${TMPDIR}/space/

            cd ${TMPDIR}/space
            git add -A
            git commit -m "Auto-deploy from GitHub Actions: $GITHUB_SHA" || true
            git push origin main

